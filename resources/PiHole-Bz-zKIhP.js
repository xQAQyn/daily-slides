import{_ as p,s as m,r as y,c as f,o as i,w as o,b as n,d as c,n as _,t as a,a as h,F as l,e as u}from"./index-BF4DSS10.js";const I={name:"PiHole",mixins:[m],props:{item:{type:Object,required:!0}},data:()=>({status:"",percent_blocked:0,sessionId:null,sessionExpiry:null,retryCount:0,maxRetries:3,retryDelay:5e3,localCheckInterval:1e3,pollInterval:null}),computed:{percentage:function(){return this.percent_blocked>=0?this.percent_blocked.toFixed(1):""},isAuthenticated(){return this.sessionId&&this.sessionExpiry&&Date.now()<this.sessionExpiry}},created(){parseInt(this.item.apiVersion,10)===6?(this.localCheckInterval=parseInt(this.item.checkInterval,10)||3e5,this.loadCachedSession(),this.startStatusPolling()):this.fetchStatus_v5()},beforeUnmount(){parseInt(this.item.apiVersion,10)===6&&this.stopStatusPolling()},methods:{handleError:function(e,t){console.error(e),this.subtitle=e,this.status=t},startStatusPolling:function(){this.fetchStatus(),this.localCheckInterval<1e3&&(this.localCheckInterval=1e3),this.pollInterval=setInterval(this.fetchStatus,this.localCheckInterval)},stopStatusPolling:function(){this.pollInterval&&clearInterval(this.pollInterval)},loadCachedSession:function(){try{const e=localStorage.getItem(`pihole_session_${this.item.url}`);if(e){const t=JSON.parse(e);t.expiry>Date.now()?(this.sessionId=t.sid,this.sessionExpiry=t.expiry):this.removeCacheSession()}}catch(e){this.handleError(`Failed to load cached session: ${e}`,"error"),this.removeCacheSession()}},removeCacheSession:function(){localStorage.removeItem(`pihole_session_${this.item.url}`),this.sessionId=null,this.sessionExpiry=null},authenticate:async function(){try{const e=await this.fetch("/api/auth",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:this.item.apikey})});if(e?.session?.sid)return this.sessionId=e.session.sid,this.sessionExpiry=Date.now()+e.session.validity*1e3,localStorage.setItem(`pihole_session_${this.item.url}`,JSON.stringify({sid:this.sessionId,expiry:this.sessionExpiry})),this.retryCount=0,!0;throw new Error("Invalid authentication response")}catch(e){return this.handleError(`Authentication failed: ${e}`,"disabled"),!1}},retryWithDelay:async function(){return console.log("Retrying authentication..."),this.retryCount<this.maxRetries?(this.retryCount++,await new Promise(e=>setTimeout(e,this.retryDelay)),this.fetchStatus()):!1},fetchStatus:async function(){try{if(!this.isAuthenticated&&this.item.apikey&&!await this.authenticate())return;const[e,t]=await Promise.all([this.fetch(`api/stats/summary?sid=${encodeURIComponent(this.sessionId)}`),this.fetch(`api/dns/blocking?sid=${encodeURIComponent(this.sessionId)}`)]);if(e?.queries?.percent_blocked===void 0||t?.blocking===void 0)throw new Error("Invalid response format");this.status=t.blocking,this.percent_blocked=e.queries.percent_blocked,this.retryCount=0}catch(e){if((e.message.includes("401 error")||e.message.includes("403 error"))&&this.item.apikey)return this.removeCacheSession(),this.retryWithDelay();this.handleError(`Failed to fetch status: ${e.message||e}`,"error"),this.removeCacheSession()}},async fetchStatus_v5(){const e=this.item.apikey?`?summaryRaw&auth=${this.item.apikey}`:"",t=await this.fetch(`/api.php${e}`).catch(s=>this.handleError(`Failed to fetch status: ${s}`,"error"));this.status=t.status,this.percent_blocked=t.ads_percentage_today}}},k={class:"title is-4"},v={class:"subtitle is-6"};function S(e,t,s,g,C,r){const d=y("Generic");return i(),f(d,{item:s.item},{content:o(()=>[h("p",k,a(s.item.name),1),h("p",v,[s.item.subtitle?(i(),n(l,{key:0},[u(a(s.item.subtitle),1)],64)):r.percentage?(i(),n(l,{key:1},[u(a(r.percentage)+"% blocked ",1)],64)):c("",!0)])]),indicator:o(()=>[e.status?(i(),n("div",{key:0,class:_(["status",e.status])},a(e.status),3)):c("",!0)]),_:1},8,["item"])}const w=p(I,[["render",S],["__scopeId","data-v-ad9ceed1"]]);export{w as default};
